name: Build Docker and Release

# 触发条件：当你推送类似 v1.0, v2.0 这样的 tag 时触发
on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write # 必须有写入权限才能发 Release

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Docker Image
        # 构建镜像
        run: docker build -t nas-search:latest .

      - name: Save Image to Tar
        # 导出为 tar 文件
        run: docker save nas-search:latest -o nas-search.tar

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: nas-search.tar
          draft: false
          prerelease: false
          # 自动把 Release 标题设为 tag 名
          name: Release ${{ github.ref_name }}
          body: "Docker 镜像自动构建完成。请下载 nas-search.tar 并上传至 NAS Container Station。"
