name: Build and Release Docker Image

on:
  push:
    tags:
      - 'v*' # 只有打标签 (如 v2601) 时才触发

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write # 需要权限创建 Release

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract Version
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build Docker Image
        # 构建镜像，标签设为 nas-search:2601
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          echo "Building image version: $VERSION"
          docker build -t nas-search:$VERSION .

      - name: Save Image to Tarball
        # 将镜像导出为 .tar.gz 文件
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          docker save nas-search:$VERSION | gzip > nas-search-$VERSION.tar.gz
          echo "Image saved: nas-search-$VERSION.tar.gz"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: nas-search-*.tar.gz
          name: Release ${{ steps.get_version.outputs.VERSION }}
          body: |
            ## NAS Search 离线镜像包
            **版本:** ${{ steps.get_version.outputs.VERSION }}
            
            ### 部署说明
            1. 下载 `nas-search-${{ steps.get_version.outputs.VERSION }}.tar.gz`
            2. 在 NAS Container Station 中导入此镜像。
            3. 创建容器，将 `data_gzip` 文件夹映射到 `/data`。
          draft: false
          prerelease: false
